<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StarForge Odyssey</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #0a0a0a;
            color: #ffffff;
            overflow-x: hidden;
        }
        html, body {
            height: 100%;
        }
        canvas {
            border: 1px solid #333;
            background: #000;
        }
        .upgrade-button {
            transition: all 0.2s;
        }
        .upgrade-button:hover:not(:disabled) {
            transform: scale(1.05);
        }
        .upgrade-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .upgrade-card {
            transition: box-shadow 0.2s, transform 0.2s;
            min-width: 0;
        }
        .upgrade-card:hover {
            box-shadow: 0 2px 8px 0 rgba(255,255,0,0.06), 0 1px 3px 0 rgba(0,0,0,0.10);
            transform: translateY(-1px) scale(1.01);
        }
        .upgrade-icon {
            filter: drop-shadow(0 0 3px rgba(255,255,255,0.15));
        }
        .upgrade-tooltip[title] {
            cursor: help;
            border-bottom: 1px dotted #888;
        }
        /* Hide scrollbar for sidebar UI */
        .hide-scrollbar {
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE 10+ */
        }
        .hide-scrollbar::-webkit-scrollbar {
            display: none; /* Chrome/Safari/Webkit */
        }
    </style>
</head>
<body class="font-mono bg-black">
    <div class="flex flex-row h-screen w-screen overflow-hidden">
        <!-- Sidebar UI -->
        <div class="bg-gray-900 p-4 rounded-none w-[340px] min-w-[260px] max-w-[400px] h-full flex flex-col overflow-y-auto hide-scrollbar">
            <h1 class="text-3xl font-bold text-left mb-4 text-yellow-400">StarForge Odyssey</h1>
            
            <div class="bg-gray-800 p-3 rounded">
                <div class="text-yellow-400 text-2xl font-bold" id="starlight">0</div>
                <div class="text-sm">Starlight</div>
                <div class="text-xs text-gray-400">(<span id="starlightPerSec">0</span>/sec)</div>
                <div id="aliveStarMultiplier" class="text-xs text-green-300 mt-1"></div>
                <div id="starCapInfo" class="text-xs text-blue-300 mt-1"></div>
            </div>
            <div class="bg-gray-800 p-3 rounded">
                <div class="text-blue-400 text-2xl font-bold" id="starsCreated">0</div>
                <div class="text-sm">Stars Crafted</div>
            </div>
            <div class="bg-gray-800 p-3 rounded">
                <div class="text-purple-400 text-2xl font-bold" id="novaShards">0</div>
                <div class="text-sm">Nova Shards</div>
            </div>

            <!-- Craft Progress -->
            <div class="mb-6">
                <div class="text-center mb-2">Crafting Progress</div>
                <div class="bg-gray-700 rounded-full h-4 relative">
                    <div id="craftProgress" class="bg-gradient-to-r from-yellow-400 to-orange-400 h-full rounded-full transition-all duration-100" style="width: 0%"></div>
                </div>
                <div class="text-center text-xs mt-1">Click the forge to speed up crafting!</div>
            </div>

            <!-- Upgrades -->
            <section class="mb-4">
                <h2 class="text-base font-bold text-yellow-400 mb-1 flex items-center gap-2"><span>Starlight Upgrades</span></h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 justify-items-stretch items-stretch">
                    <!-- Crafting Speed -->
                    <div class="upgrade-card bg-gray-800 rounded-md p-2 flex flex-col items-center relative shadow-lg h-full flex-1">
                        <span class="upgrade-icon text-yellow-300 text-xl mb-0.5">‚ö°</span>
                        <h3 class="font-bold text-yellow-300 text-xs">Crafting Speed</h3>
                        <button id="craftSpeedBtn" class="upgrade-button bg-yellow-600 hover:bg-yellow-700 px-2 py-0.5 rounded-md text-xs font-semibold mt-1 w-full transition-all duration-150">Upgrade <span class="text-[10px]">(Cost: <span id="craftSpeedCost">10</span>)</span></button>
                        <div class="w-full mt-1 flex justify-between text-[10px]">
                            <span>Level: <span id="craftSpeedLevel">0</span></span>
                            <span>Stars/sec: <span id="craftSpeedValue">0.1</span></span>
                        </div>
                        <div class="upgrade-tooltip mt-0.5 text-gray-400 text-[10px] text-center" title="Increase star crafting speed">Increase star crafting speed</div>
                    </div>
                    <!-- Starlight per Star -->
                    <div class="upgrade-card bg-gray-800 rounded-md p-2 flex flex-col items-center relative shadow-lg h-full flex-1">
                        <span class="upgrade-icon text-blue-300 text-xl mb-0.5">üí°</span>
                        <h3 class="font-bold text-blue-300 text-xs">Starlight Value</h3>
                        <button id="starlightValueBtn" class="upgrade-button bg-blue-600 hover:bg-blue-700 px-2 py-0.5 rounded-md text-xs font-semibold mt-1 w-full transition-all duration-150">Upgrade <span class="text-[10px]">(Cost: <span id="starlightValueCost">15</span>)</span></button>
                        <div class="w-full mt-1 flex justify-between text-[10px]">
                            <span>Level: <span id="starlightValueLevel">0</span></span>
                            <span>Starlight/star: <span id="starlightValueAmount">1</span></span>
                        </div>
                        <div class="upgrade-tooltip mt-0.5 text-gray-400 text-[10px] text-center" title="Increase starlight per star">Increase starlight per star</div>
                    </div>
                    <!-- Star Quality -->
                    <div class="upgrade-card bg-gray-800 rounded-md p-2 flex flex-col items-center relative shadow-lg h-full flex-1">
                        <span class="upgrade-icon text-purple-300 text-xl mb-0.5">üåü</span>
                        <h3 class="font-bold text-purple-300 text-xs">Star Quality</h3>
                        <button id="starQualityBtn" class="upgrade-button bg-purple-600 hover:bg-purple-700 px-2 py-0.5 rounded-md text-xs font-semibold mt-1 w-full transition-all duration-150">Upgrade <span class="text-[10px]">(Cost: <span id="starQualityCost">100</span>)</span></button>
                        <div class="w-full mt-1 flex justify-between text-[10px]">
                            <span>Level: <span id="starQualityLevel">0</span></span>
                            <span>Quality: <span id="starQualityName">Dim</span></span>
                        </div>
                        <div class="upgrade-tooltip mt-0.5 text-gray-400 text-[10px] text-center" title="Increase star quality">Increase star quality</div>
                    </div>
                    <!-- Automation -->
                    <div class="upgrade-card bg-gray-800 rounded-md p-2 flex flex-col items-center relative shadow-lg h-full flex-1">
                        <span class="upgrade-icon text-green-300 text-xl mb-0.5">ü§ñ</span>
                        <h3 class="font-bold text-green-300 text-xs">Automation</h3>
                        <button id="automationBtn" class="upgrade-button bg-green-600 hover:bg-green-700 px-2 py-0.5 rounded-md text-xs font-semibold mt-1 w-full transition-all duration-150">Unlock <span class="text-[10px]">(Cost: <span id="automationCost">500</span>)</span></button>
                        <div class="w-full mt-1 flex justify-between text-[10px]">
                            <span>Status: <span id="automationStatus">Locked</span></span>
                        </div>
                        <div class="upgrade-tooltip mt-0.5 text-gray-400 text-[10px] text-center" title="Automatically craft stars">Automatically craft stars</div>
                    </div>
                    <!-- Star Longevity -->
                    <div class="upgrade-card bg-gray-800 rounded-md p-2 flex flex-col items-center relative shadow-lg h-full flex-1">
                        <span class="upgrade-icon text-pink-300 text-xl mb-0.5">‚è≥</span>
                        <h3 class="font-bold text-pink-300 text-xs">Star Longevity</h3>
                        <button id="starLongevityBtn" class="upgrade-button bg-pink-600 hover:bg-pink-700 px-2 py-0.5 rounded-md text-xs font-semibold mt-1 w-full transition-all duration-150">Upgrade <span class="text-[10px]">(Cost: <span id="starLongevityCost">50</span>)</span></button>
                        <div class="w-full mt-1 flex justify-between text-[10px]">
                            <span>Level: <span id="starLongevityLevel">0</span></span>
                            <span>Life: <span id="starLongevityValue">5</span>s</span>
                        </div>
                        <div class="w-full text-[10px] text-pink-200 text-center">Starlight per star: <span id="starLifetimeStarlight">0</span></div>
                        <div class="upgrade-tooltip mt-0.5 text-gray-400 text-[10px] text-center" title="Increase star lifetime and decay starlight">Increase star lifetime and decay starlight</div>
                    </div>
                </div>
            </section>

            <section class="mb-4">
                <h2 class="text-base font-bold text-yellow-200 mb-1 flex items-center gap-2"><span>Constellation Upgrades</span></h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-2 justify-items-stretch items-stretch">
                    <!-- Constellation Power -->
                    <div class="upgrade-card bg-gray-800 rounded-md p-2 flex flex-col items-center relative shadow-lg h-full flex-1">
                        <span class="upgrade-icon text-yellow-200 text-xl mb-0.5">‚ú®</span>
                        <h3 class="font-bold text-yellow-200 text-xs">Constellation Power</h3>
                        <button id="constellationPowerBtn" class="upgrade-button bg-yellow-700 hover:bg-yellow-800 px-2 py-0.5 rounded-md text-xs font-semibold mt-1 w-full transition-all duration-150">Upgrade <span class="text-[10px]">(Cost: <span id="constellationPowerCost">100</span> Stars Crafted)</span></button>
                        <div class="w-full mt-1 flex justify-between text-[10px]">
                            <span>Level: <span id="constellationPowerLevel">0</span></span>
                        </div>
                        <div class="upgrade-tooltip mt-0.5 text-gray-400 text-[10px] text-center" title="+10% Starlight/star per level">+10% Starlight/star per level</div>
                    </div>
                    <!-- Celestial Efficiency -->
                    <div class="upgrade-card bg-gray-800 rounded-md p-2 flex flex-col items-center relative shadow-lg h-full flex-1">
                        <span class="upgrade-icon text-blue-200 text-xl mb-0.5">üõ†Ô∏è</span>
                        <h3 class="font-bold text-blue-200 text-xs">Celestial Efficiency</h3>
                        <button id="celestialEfficiencyBtn" class="upgrade-button bg-blue-700 hover:bg-blue-800 px-2 py-0.5 rounded-md text-xs font-semibold mt-1 w-full transition-all duration-150">Upgrade <span class="text-[10px]">(Cost: <span id="celestialEfficiencyCost">200</span> Stars Crafted)</span></button>
                        <div class="w-full mt-1 flex justify-between text-[10px]">
                            <span>Level: <span id="celestialEfficiencyLevel">0</span></span>
                        </div>
                        <div class="upgrade-tooltip mt-0.5 text-gray-400 text-[10px] text-center" title="+5% Crafting Speed per level">+5% Crafting Speed per level</div>
                    </div>
                    <!-- Galactic Magnetism -->
                    <div class="upgrade-card bg-gray-800 rounded-md p-2 flex flex-col items-center relative shadow-lg h-full flex-1">
                        <span class="upgrade-icon text-purple-200 text-xl mb-0.5">üß≤</span>
                        <h3 class="font-bold text-purple-200 text-xs">Galactic Magnetism</h3>
                        <button id="galacticMagnetismBtn" class="upgrade-button bg-purple-700 hover:bg-purple-800 px-2 py-0.5 rounded-md text-xs font-semibold mt-1 w-full transition-all duration-150">Upgrade <span class="text-[10px]">(Cost: <span id="galacticMagnetismCost">150</span> Stars Crafted)</span></button>
                        <div class="w-full mt-1 flex justify-between text-[10px]">
                            <span>Level: <span id="galacticMagnetismLevel">0</span></span>
                        </div>
                        <div class="upgrade-tooltip mt-0.5 text-gray-400 text-[10px] text-center" title="+10% Star Decay Starlight per level">+10% Star Decay Starlight per level</div>
                    </div>
                    <!-- Astral Storage -->
                    <div class="upgrade-card bg-gray-800 rounded-md p-2 flex flex-col items-center relative shadow-lg h-full flex-1">
                        <span class="upgrade-icon text-pink-200 text-xl mb-0.5">üì¶</span>
                        <h3 class="font-bold text-pink-200 text-xs">Astral Storage</h3>
                        <button id="astralStorageBtn" class="upgrade-button bg-pink-700 hover:bg-pink-800 px-2 py-0.5 rounded-md text-xs font-semibold mt-1 w-full transition-all duration-150">Upgrade <span class="text-[10px]">(Cost: <span id="astralStorageCost">250</span> Stars Crafted)</span></button>
                        <div class="w-full mt-1 flex justify-between text-[10px]">
                            <span>Level: <span id="astralStorageLevel">0</span></span>
                        </div>
                        <div class="upgrade-tooltip mt-0.5 text-gray-400 text-[10px] text-center" title="+10 Max Stars per level">+10 Max Stars per level</div>
                    </div>
                </div>
            </section>

            <!-- Prestige -->
            <div class="mt-6 text-center">
                <button id="prestigeBtn" class="upgrade-button bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 px-4 py-2 rounded-lg font-bold text-base disabled:from-gray-600 disabled:to-gray-700">
                    Nova Reset (Requires 1000 stars or 10000 starlight)
                </button>
                <div class="text-xs mt-2" id="prestigeInfo"></div>
            </div>

            <section class="mb-4">
                <h2 class="text-base font-bold text-purple-300 mb-1 flex items-center gap-2"><span>Nova Shard Upgrades</span></h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2 justify-items-stretch items-stretch">
                    <!-- Quantum Forge -->
                    <div class="upgrade-card bg-gray-800 rounded-md p-2 flex flex-col items-center relative shadow-lg h-full flex-1">
                        <span class="upgrade-icon text-yellow-300 text-xl mb-0.5">üß¨</span>
                        <h3 class="font-bold text-yellow-300 text-xs">Quantum Forge</h3>
                        <button id="quantumForgeBtn" class="upgrade-button bg-yellow-700 hover:bg-yellow-800 px-2 py-0.5 rounded-md text-xs font-semibold mt-1 w-full transition-all duration-150">Upgrade <span class="text-[10px]">(Cost: <span id="quantumForgeCost">1</span> Nova Shard)</span></button>
                        <div class="w-full mt-1 flex justify-between text-[10px]">
                            <span>Level: <span id="quantumForgeLevel">0</span></span>
                        </div>
                        <div class="upgrade-tooltip mt-0.5 text-gray-400 text-[10px] text-center" title="+10% Crafting Speed per level">+10% Crafting Speed per level</div>
                    </div>
                    <!-- Eternal Light -->
                    <div class="upgrade-card bg-gray-800 rounded-md p-2 flex flex-col items-center relative shadow-lg h-full flex-1">
                        <span class="upgrade-icon text-blue-300 text-xl mb-0.5">üîÜ</span>
                        <h3 class="font-bold text-blue-300 text-xs">Eternal Light</h3>
                        <button id="eternalLightBtn" class="upgrade-button bg-blue-700 hover:bg-blue-800 px-2 py-0.5 rounded-md text-xs font-semibold mt-1 w-full transition-all duration-150">Upgrade <span class="text-[10px]">(Cost: <span id="eternalLightCost">1</span> Nova Shard)</span></button>
                        <div class="w-full mt-1 flex justify-between text-[10px]">
                            <span>Level: <span id="eternalLightLevel">0</span></span>
                        </div>
                        <div class="upgrade-tooltip mt-0.5 text-gray-400 text-[10px] text-center" title="+10% Starlight/star per level">+10% Starlight/star per level</div>
                    </div>
                    <!-- Celestial Memory -->
                    <div class="upgrade-card bg-gray-800 rounded-md p-2 flex flex-col items-center relative shadow-lg h-full flex-1">
                        <span class="upgrade-icon text-green-300 text-xl mb-0.5">üß†</span>
                        <h3 class="font-bold text-green-300 text-xs">Celestial Memory</h3>
                        <button id="celestialMemoryBtn" class="upgrade-button bg-green-700 hover:bg-green-800 px-2 py-0.5 rounded-md text-xs font-semibold mt-1 w-full transition-all duration-150">Upgrade <span class="text-[10px]">(Cost: <span id="celestialMemoryCost">2</span> Nova Shards)</span></button>
                        <div class="w-full mt-1 flex justify-between text-[10px]">
                            <span>Level: <span id="celestialMemoryLevel">0</span></span>
                        </div>
                        <div class="upgrade-tooltip mt-0.5 text-gray-400 text-[10px] text-center" title="+5% Offline Starlight per level">+5% Offline Starlight per level</div>
                    </div>
                    <!-- Stellar Magnet -->
                    <div class="upgrade-card bg-gray-800 rounded-md p-2 flex flex-col items-center relative shadow-lg h-full flex-1">
                        <span class="upgrade-icon text-pink-300 text-xl mb-0.5">ü™ê</span>
                        <h3 class="font-bold text-pink-300 text-xs">Stellar Magnet</h3>
                        <button id="stellarMagnetBtn" class="upgrade-button bg-pink-700 hover:bg-pink-800 px-2 py-0.5 rounded-md text-xs font-semibold mt-1 w-full transition-all duration-150">Upgrade <span class="text-[10px]">(Cost: <span id="stellarMagnetCost">3</span> Nova Shards)</span></button>
                        <div class="w-full mt-1 flex justify-between text-[10px]">
                            <span>Level: <span id="stellarMagnetLevel">0</span></span>
                        </div>
                        <div class="upgrade-tooltip mt-0.5 text-gray-400 text-[10px] text-center" title="+1% Alive Star Multiplier per level">+1% Alive Star Multiplier per level</div>
                    </div>
                    <!-- Astral Echo -->
                    <div class="upgrade-card bg-gray-800 rounded-md p-2 flex flex-col items-center relative shadow-lg h-full flex-1">
                        <span class="upgrade-icon text-yellow-200 text-xl mb-0.5">üîî</span>
                        <h3 class="font-bold text-yellow-200 text-xs">Astral Echo</h3>
                        <button id="astralEchoBtn" class="upgrade-button bg-yellow-600 hover:bg-yellow-700 px-2 py-0.5 rounded-md text-xs font-semibold mt-1 w-full transition-all duration-150">Upgrade <span class="text-[10px]">(Cost: <span id="astralEchoCost">3</span> Nova Shards)</span></button>
                        <div class="w-full mt-1 flex justify-between text-[10px]">
                            <span>Level: <span id="astralEchoLevel">0</span></span>
                        </div>
                        <div class="upgrade-tooltip mt-0.5 text-gray-400 text-[10px] text-center" title="+1 Base Star Life per level">+1 Base Star Life per level</div>
                    </div>
                </div>
            </section>

            <!-- Stats -->
            <div class="mt-4 text-xs text-gray-400 text-center">
                Total Starlight Earned: <span id="totalStarlight">0</span> | 
                Play Time: <span id="playTime">0:00</span> | 
                Last Save: <span id="lastSave">Never</span>
            </div>

            <!-- Save/Load/Reset Controls -->
            <div class="mt-6 flex flex-col gap-2">
                <button id="saveGameBtn" class="upgrade-button bg-blue-700 hover:bg-blue-800 text-xs py-2">Save Game</button>
                <button id="loadGameBtn" class="upgrade-button bg-green-700 hover:bg-green-800 text-xs py-2">Load Game</button>
                <button id="resetGameBtn" class="upgrade-button bg-red-700 hover:bg-red-800 text-xs py-2">Reset Game</button>
                <div id="saveLoadNotif" class="text-xs text-center text-green-400 mt-2" style="display:none;"></div>
            </div>

        </div>
        <!-- Main Starfield Area -->
        <div class="flex-1 flex items-center justify-center bg-black">
            <canvas id="gameCanvas" width="1500" height="1050" class="block shadow-lg border border-gray-700 rounded-lg"></canvas>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Game State
            const gameState = {
                starlight: 0,
                totalStarlight: 0,
                starsCreated: 0,
                novaShards: 0,
                craftProgress: 0,
                craftTime: 10,
                starsPerSecond: 0.1,
                starlightPerStar: 1,
                starQuality: 1,
                starQualityName: "Dim",
                
                // Upgrade levels
                upgrades: {
                    craftSpeed: { level: 0, baseCost: 10, costMultiplier: 1.15 },
                    starlightValue: { level: 0, baseCost: 15, costMultiplier: 1.2 },
                    starQuality: { level: 0, baseCost: 100, costMultiplier: 2 },
                    automation: { level: 0, baseCost: 500, unlocked: false },
                    starLongevity: { level: 0, baseCost: 50, costMultiplier: 2 },
                    constellationPower: { level: 0, baseCost: 100, costMultiplier: 2 },
                    celestialEfficiency: { level: 0, baseCost: 200, costMultiplier: 2 },
                    galacticMagnetism: { level: 0, baseCost: 150, costMultiplier: 2 },
                    astralStorage: { level: 0, baseCost: 10, costMultiplier: 1.1 },
                    quantumForge: { level: 0, baseCost: 1, costMultiplier: 2 },
                    eternalLight: { level: 0, baseCost: 1, costMultiplier: 2 },
                    celestialMemory: { level: 0, baseCost: 2, costMultiplier: 2 },
                    stellarMagnet: { level: 0, baseCost: 3, costMultiplier: 2 },
                    astralEcho: { level: 0, baseCost: 3, costMultiplier: 2 }
                },
                
                // Visual elements
                stars: [],
                blackHoles: [],
                forgeRotation: 0,
                
                // Time tracking
                lastUpdate: Date.now(),
                startTime: Date.now(),
                lastSave: Date.now(),
                baseStarLife: 5, // base life in seconds
                starLifePerLevel: 2, // seconds per upgrade level
                starlightMultiplier: 1, // New property for starlight multiplier
            };

            // Canvas setup
            const canvas = document.getElementById('gameCanvas');
            if (!canvas) {
                console.error('Canvas element with id "gameCanvas" not found!');
            }
            const ctx = canvas ? canvas.getContext('2d') : null;
            if (!ctx) {
                console.error('2D context for canvas not found!');
            }
            const centerX = canvas ? canvas.width / 2 : 400;
            const centerY = canvas ? canvas.height / 2 : 300;

            // Star class
            class Star {
                constructor(quality, life) {
                    this.x = centerX;
                    this.y = centerY;
                    this.angle = Math.random() * Math.PI * 2;
                    this.radius = 0;
                    // Clamp targetRadius so stars never go off-canvas
                    const margin = 20;
                    const maxStarSize = 10;
                    const maxRadius = Math.min(centerX, centerY) - maxStarSize - margin;
                    const minRadius = 80;
                    this.targetRadius = Math.random() * (maxRadius - minRadius) + minRadius;
                    this.speed = 0.5 + Math.random() * 0.5;
                    this.quality = quality;
                    this.trail = [];
                    this.maxTrailLength = 20 + quality * 10;
                    // Supernova Surge: Dramatic brightness and glow
                    this.surgeLevel = 0; // Removed as per edit
                    this.brightness = 1; // Removed as per edit
                    this.opacity = 1; // Always start fully visible
                    this.size = 2 + quality;
                    this.life = life; // Star life in seconds
                    this.maxLife = life;
                    // Color based on quality
                    const colors = [
                        { r: 255, g: 255, b: 200 }, // Dim
                        { r: 255, g: 255, b: 100 }, // Bright
                        { r: 255, g: 200, b: 50 },  // Radiant
                        { r: 255, g: 150, b: 255 }  // Nova
                    ];
                    this.color = colors[Math.min(quality - 1, colors.length - 1)];
                }

                update(deltaTime) {
                    // Move outward
                    if (this.radius < this.targetRadius) {
                        this.radius += deltaTime * 50;
                    }
                    
                    // Orbit
                    this.angle += this.speed * deltaTime;
                    
                    // Calculate position
                    this.x = centerX + Math.cos(this.angle) * this.radius;
                    this.y = centerY + Math.sin(this.angle) * this.radius;
                    
                    // Update trail
                    this.trail.push({ x: this.x, y: this.y });
                    if (this.trail.length > this.maxTrailLength) {
                        this.trail.shift();
                    }
                    
                    // Fade out only in the last second of life
                    if (this.life < 1) {
                        this.opacity -= deltaTime * 0.5;
                    }
                    // Decay life
                    this.life -= deltaTime;
                }

                isAlive() {
                    return this.life > 0;
                }

                draw(ctx) {
                    // Draw trail
                    ctx.strokeStyle = `rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${this.opacity * 0.4 * this.brightness})`;
                    ctx.lineWidth = this.size * 0.5 + this.surgeLevel * 0.5; // Removed surgeLevel from lineWidth
                    ctx.beginPath();
                    for (let i = 0; i < this.trail.length; i++) {
                        const point = this.trail[i];
                        const alpha = (i / this.trail.length) * this.opacity * 0.7 * this.brightness;
                        ctx.globalAlpha = alpha;
                        if (i === 0) {
                            ctx.moveTo(point.x, point.y);
                        } else {
                            ctx.lineTo(point.x, point.y);
                        }
                    }
                    ctx.stroke();
                    ctx.globalAlpha = 1;
                    
                    // Draw star
                    ctx.fillStyle = `rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${this.opacity * this.brightness})`;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Dramatic Glow effect
                    const glowRadius = this.size * (3 + this.surgeLevel * 2) * 0.25; // Removed surgeLevel from glowRadius
                    const gradient = ctx.createRadialGradient(this.x, this.y, 0, this.x, this.y, glowRadius);
                    gradient.addColorStop(0, `rgba(255,255,255,${0.4 * this.surgeLevel})`); // white core for high surge
                    gradient.addColorStop(0.2, `rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, ${this.opacity * 0.7 * this.brightness})`);
                    gradient.addColorStop(1, `rgba(${this.color.r}, ${this.color.g}, ${this.color.b}, 0)`);
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, glowRadius, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            // Black Hole class
            class BlackHole {
                constructor(angle, radius, count) {
                    this.angle = angle;
                    this.radius = radius;
                    this.count = count; // number of stars it represents
                    this.size = 18 + Math.log2(count) * 4;
                    this.orbitSpeed = 0.2 + Math.random() * 0.2;
                    this.orbitOffset = Math.random() * Math.PI * 2;
                }
                update(deltaTime) {
                    this.angle += this.orbitSpeed * deltaTime;
                }
                draw(ctx) {
                    const x = centerX + Math.cos(this.angle + this.orbitOffset) * this.radius;
                    const y = centerY + Math.sin(this.angle + this.orbitOffset) * this.radius;
                    // Black core
                    ctx.save();
                    ctx.globalAlpha = 0.85;
                    ctx.beginPath();
                    ctx.arc(x, y, this.size, 0, Math.PI * 2);
                    ctx.fillStyle = 'black';
                    ctx.shadowColor = '#6b21a8';
                    ctx.shadowBlur = 18;
                    ctx.fill();
                    ctx.globalAlpha = 1;
                    // Swirl/accretion disk
                    ctx.beginPath();
                    ctx.arc(x, y, this.size * 1.25, 0, Math.PI * 2);
                    ctx.strokeStyle = 'rgba(107,33,168,0.7)';
                    ctx.lineWidth = 4;
                    ctx.setLineDash([6, 8]);
                    ctx.stroke();
                    ctx.setLineDash([]);
                    // Star count overlay
                    ctx.font = `${Math.round(this.size * 0.9)}px monospace`;
                    ctx.fillStyle = '#fff';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.shadowColor = '#000';
                    ctx.shadowBlur = 4;
                    ctx.fillText(this.count, x, y);
                    ctx.restore();
                }
            }

            // Draw forge
            function drawForge(ctx) {
                ctx.save();
                ctx.translate(centerX, centerY);
                ctx.rotate(gameState.forgeRotation);
                
                // Hexagonal forge
                const size = 40;
                const sides = 6;
                
                // Glow
                const glowGradient = ctx.createRadialGradient(0, 0, 0, 0, 0, size * 2);
                glowGradient.addColorStop(0, 'rgba(255, 200, 0, 0.8)');
                glowGradient.addColorStop(0.5, 'rgba(255, 150, 0, 0.4)');
                glowGradient.addColorStop(1, 'rgba(255, 100, 0, 0)');
                ctx.fillStyle = glowGradient;
                ctx.beginPath();
                ctx.arc(0, 0, size * 2, 0, Math.PI * 2);
                ctx.fill();
                
                // Forge body
                ctx.fillStyle = '#ffaa00';
                ctx.strokeStyle = '#ff8800';
                ctx.lineWidth = 3;
                ctx.beginPath();
                for (let i = 0; i < sides; i++) {
                    const angle = (Math.PI * 2 / sides) * i;
                    const x = Math.cos(angle) * size;
                    const y = Math.sin(angle) * size;
                    if (i === 0) ctx.moveTo(x, y);
                    else ctx.lineTo(x, y);
                }
                ctx.closePath();
                ctx.fill();
                ctx.stroke();
                
                // Inner detail
                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(0, 0, size * 0.3, 0, Math.PI * 2);
                ctx.fill();

                ctx.restore();
            }

            // Update game logic
            function update() {
                const now = Date.now();
                const deltaTime = (now - gameState.lastUpdate) / 1000;
                gameState.lastUpdate = now;
                
                // Update forge rotation
                gameState.forgeRotation += deltaTime * (0.5 + gameState.starsPerSecond);
                
                // Count alive stars
                const aliveStars = gameState.stars.length;
                // Starlight multiplier: +1% per alive star (+1% per Stellar Magnet level)
                const aliveStarBonus = 0.2 + 0.2 * gameState.upgrades.stellarMagnet.level; // MASSIVE bonus
                const starlightMultiplier = 1 + aliveStars * aliveStarBonus;
                gameState.starlightMultiplier = starlightMultiplier;
                // Update craft progress
                // Quantum Forge: +10% crafting speed per level
                let quantumForgeBonus = 1 + 0.1 * gameState.upgrades.quantumForge.level;
                gameState.craftProgress += (deltaTime / gameState.craftTime) * gameState.starsPerSecond * 10 * quantumForgeBonus;
                
                if (gameState.craftProgress >= 1) {
                    // Create star
                    gameState.starsCreated++;
                    // Eternal Light: +10% starlight per star per level
                    let eternalLightBonus = 1 + 0.1 * gameState.upgrades.eternalLight.level;
                    // Supernova Surge: +20% starlight per star per level
                    let supernovaSurgeBonus = 1 + 0.2 * gameState.upgrades.supernovaSurge.level;
                    const starlight = gameState.starlightPerStar * gameState.starQuality * (1 + gameState.novaShards * 0.1) * eternalLightBonus * starlightMultiplier;
                    gameState.starlight += starlight;
                    gameState.totalStarlight += starlight;
                    
                    // Add visual star with life
                    // Astral Echo: +2 base star life per level
                    const starLife = gameState.baseStarLife + gameState.upgrades.starLongevity.level * gameState.starLifePerLevel + 2 * (gameState.upgrades.astralEcho?.level || 0);
                    gameState.stars.push(new Star(gameState.starQuality, starLife));
                    
                    // Reset progress
                    gameState.craftProgress = gameState.upgrades.automation.unlocked ? gameState.craftProgress - 1 : 0;
                }
                
                // Update stars and starlight from decaying stars
                gameState.stars = gameState.stars.filter(star => {
                    if (star.life > 0) {
                        let starlightPerSecond = 0.2 * star.quality * (1 + gameState.novaShards * 0.1);
                        starlightPerSecond *= 1 + 0.1 * gameState.upgrades.galacticMagnetism.level;
                        // Do NOT apply Supernova Surge to decay starlight
                        starlightPerSecond *= starlightMultiplier;
                        gameState.starlight += starlightPerSecond * deltaTime;
                        gameState.totalStarlight += starlightPerSecond * deltaTime;
                    }
                    star.update(deltaTime);
                    return star.isAlive();
                });
                // Limit stars for performance (with astralStorage bonus)
                let maxStars = 5 + 10 * gameState.upgrades.astralStorage.level;
                if (gameState.stars.length > maxStars) {
                    gameState.stars = gameState.stars.slice(-maxStars);
                }
                
                // Black hole mechanic: combine every 25 stars into a black hole
                while (gameState.stars.length >= 25) {
                    // Remove 25 oldest stars
                    gameState.stars.splice(0, 25);
                    // Place black hole at a random orbit
                    const angle = Math.random() * Math.PI * 2;
                    const margin = 40;
                    const maxRadius = Math.min(centerX, centerY) - 30 - margin;
                    const minRadius = 120;
                    const radius = Math.random() * (maxRadius - minRadius) + minRadius;
                    gameState.blackHoles.push(new BlackHole(angle, radius, 25));
                }
                
                // Update black holes
                for (const bh of gameState.blackHoles) {
                    bh.update(deltaTime);
                }
                
                // Auto-save
                if (now - gameState.lastSave > 30000) {
                    saveGame();
                }
                
                updateUI();
            }

            // Render game
            function render() {
                // Clear canvas
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw background stars
                ctx.fillStyle = '#fff';
                for (let i = 0; i < 100; i++) {
                    const x = (i * 73) % canvas.width;
                    const y = (i * 37) % canvas.height;
                    const size = ((i * 13) % 3) * 0.5;
                    ctx.globalAlpha = 0.3 + ((i * 7) % 5) * 0.1;
                    ctx.fillRect(x, y, size, size);
                }
                ctx.globalAlpha = 1;
                
                // Draw stars
                gameState.stars.forEach(star => star.draw(ctx));
                // Draw black holes
                gameState.blackHoles.forEach(bh => bh.draw(ctx));
                
                // Draw forge
                drawForge(ctx);
                
                // Draw craft progress indicator
                if (gameState.craftProgress > 0) {
                    ctx.strokeStyle = `rgba(255, 255, 0, ${0.5 + gameState.craftProgress * 0.5})`;
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, 60, -Math.PI/2, -Math.PI/2 + (Math.PI * 2 * gameState.craftProgress));
                    ctx.stroke();
                }
            }

            // Game loop
            function gameLoop() {
                try {
                    update();
                    render();
                } catch (e) {
                    console.error('Error in game loop:', e);
                }
                requestAnimationFrame(gameLoop);
            }

            // Update UI
            function updateUI() {
                // Stats
                document.getElementById('starlight').textContent = Math.floor(gameState.starlight).toLocaleString();
                document.getElementById('starsCreated').textContent = gameState.starsCreated.toLocaleString();
                document.getElementById('novaShards').textContent = gameState.novaShards.toLocaleString();
                
                // Starlight per second
                const starlightPerSec = gameState.starsPerSecond * gameState.starlightPerStar * gameState.starQuality * (1 + gameState.novaShards * 0.1) * (gameState.starlightMultiplier || 1);
                document.getElementById('starlightPerSec').textContent = starlightPerSec.toFixed(1);
                // Show alive star multiplier in Starlight card
                const multiplierElem = document.getElementById('aliveStarMultiplier');
                if (multiplierElem) {
                    multiplierElem.textContent = `Alive Star Bonus: x${(gameState.starlightMultiplier || 1).toFixed(2)}`;
                }
                // Show current stars vs cap
                const starCapElem = document.getElementById('starCapInfo');
                if (starCapElem) {
                    const maxStars = 5 + 10 * (gameState.upgrades.astralStorage?.level || 0);
                    starCapElem.textContent = `Stars: ${gameState.stars.length} / ${maxStars}`;
                }
                
                // Craft progress
                document.getElementById('craftProgress').style.width = `${gameState.craftProgress * 100}%`;
                
                // Upgrades
                updateUpgradeButton('craftSpeed', 'craftSpeedBtn', 'craftSpeedCost', 'craftSpeedLevel', 'craftSpeedValue');
                updateUpgradeButton('starlightValue', 'starlightValueBtn', 'starlightValueCost', 'starlightValueLevel', 'starlightValueAmount');
                updateUpgradeButton('starQuality', 'starQualityBtn', 'starQualityCost', 'starQualityLevel', 'starQualityName');
                updateUpgradeButton('starLongevity', 'starLongevityBtn', 'starLongevityCost', 'starLongevityLevel', 'starLongevityValue');
                updateAutomationButton();
                
                // Constellation Upgrades UI
                updateConstellationUpgradeButton('constellationPower', 'constellationPowerBtn', 'constellationPowerCost', 'constellationPowerLevel');
                updateConstellationUpgradeButton('celestialEfficiency', 'celestialEfficiencyBtn', 'celestialEfficiencyCost', 'celestialEfficiencyLevel');
                updateConstellationUpgradeButton('galacticMagnetism', 'galacticMagnetismBtn', 'galacticMagnetismCost', 'galacticMagnetismLevel');
                updateConstellationUpgradeButton('astralStorage', 'astralStorageBtn', 'astralStorageCost', 'astralStorageLevel');
                
                // Nova Shard Upgrades UI
                updateNovaShardUpgradeButton('quantumForge', 'quantumForgeBtn', 'quantumForgeCost', 'quantumForgeLevel');
                updateNovaShardUpgradeButton('eternalLight', 'eternalLightBtn', 'eternalLightCost', 'eternalLightLevel');
                updateNovaShardUpgradeButton('celestialMemory', 'celestialMemoryBtn', 'celestialMemoryCost', 'celestialMemoryLevel');
                updateNovaShardUpgradeButton('stellarMagnet', 'stellarMagnetBtn', 'stellarMagnetCost', 'stellarMagnetLevel');
                updateNovaShardUpgradeButton('astralEcho', 'astralEchoBtn', 'astralEchoCost', 'astralEchoLevel');
                
                // Prestige
                const canPrestige = gameState.starsCreated >= 1000 || gameState.totalStarlight >= 10000;
                document.getElementById('prestigeBtn').disabled = !canPrestige;
                if (canPrestige) {
                    const shards = Math.floor(Math.sqrt(gameState.totalStarlight / 100));
                    // Calculate starlight gain increase
                    const currentMultiplier = 1 + (gameState.novaShards * 0.1);
                    const newMultiplier = 1 + ((gameState.novaShards + shards) * 0.1);
                    const percentIncrease = ((newMultiplier / currentMultiplier - 1) * 100).toFixed(1);
                    document.getElementById('prestigeInfo').textContent = `You will gain ${shards} Nova Shards (+${percentIncrease}% starlight gain)`;
                } else {
                    document.getElementById('prestigeInfo').textContent = '';
                }
                
                // Other stats
                document.getElementById('totalStarlight').textContent = Math.floor(gameState.totalStarlight).toLocaleString();
                const playTime = Math.floor((Date.now() - gameState.startTime) / 1000);
                const minutes = Math.floor(playTime / 60);
                const seconds = playTime % 60;
                document.getElementById('playTime').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                const lastSaveAgo = Math.floor((Date.now() - gameState.lastSave) / 1000);
                document.getElementById('lastSave').textContent = `${lastSaveAgo}s ago`;
            }

            // Update upgrade button
            function updateUpgradeButton(upgradeName, btnId, costId, levelId, valueId) {
                const upgrade = gameState.upgrades[upgradeName];
                const cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.costMultiplier, upgrade.level));
                
                document.getElementById(btnId).disabled = gameState.starlight < cost;
                document.getElementById(costId).textContent = cost.toLocaleString();
                document.getElementById(levelId).textContent = upgrade.level;
                
                if (upgradeName === 'craftSpeed') {
                    // Apply celestialEfficiency bonus
                    let speed = gameState.starsPerSecond * (1 + 0.05 * gameState.upgrades.celestialEfficiency.level);
                    document.getElementById(valueId).textContent = speed.toFixed(2);
                } else if (upgradeName === 'starlightValue') {
                    // Apply constellationPower bonus
                    let value = gameState.starlightPerStar * (1 + 0.1 * gameState.upgrades.constellationPower.level);
                    document.getElementById(valueId).textContent = value.toFixed(1);
                } else if (upgradeName === 'starQuality') {
                    document.getElementById(valueId).textContent = gameState.starQualityName;
                } else if (upgradeName === 'starLongevity') {
                    const starLife = gameState.baseStarLife + gameState.upgrades.starLongevity.level * gameState.starLifePerLevel + 2 * (gameState.upgrades.astralEcho?.level || 0);
                    document.getElementById(valueId).textContent = starLife.toFixed(1);
                    // Calculate total starlight per star
                    // Apply constellationPower and galacticMagnetism bonuses
                    const creation = gameState.starlightPerStar * (1 + 0.1 * gameState.upgrades.constellationPower.level) * gameState.starQuality * (1 + gameState.novaShards * 0.1);
                    let starlightPerSecond = 0.2 * gameState.starQuality * (1 + gameState.novaShards * 0.1);
                    starlightPerSecond *= 1 + 0.1 * gameState.upgrades.galacticMagnetism.level;
                    const decay = starLife * starlightPerSecond;
                    const total = creation + decay;
                    document.getElementById('starLifetimeStarlight').textContent = total.toFixed(1);
                }
            }

            // Update automation button
            function updateAutomationButton() {
                const upgrade = gameState.upgrades.automation;
                const btn = document.getElementById('automationBtn');
                const status = document.getElementById('automationStatus');
                
                if (upgrade.unlocked) {
                    btn.textContent = 'Unlocked';
                    btn.disabled = true;
                    status.textContent = 'Active';
                    status.className = 'text-green-400';
                } else {
                    btn.disabled = gameState.starlight < upgrade.baseCost;
                    status.textContent = 'Locked';
                    status.className = 'text-gray-400';
                }
            }

            // Update Constellation Upgrade Button
            function updateConstellationUpgradeButton(upgradeName, btnId, costId, levelId) {
                const upgrade = gameState.upgrades[upgradeName];
                const cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.costMultiplier, upgrade.level));
                document.getElementById(btnId).disabled = gameState.starsCreated < cost;
                document.getElementById(costId).textContent = cost.toLocaleString();
                document.getElementById(levelId).textContent = upgrade.level;
            }

            // Update Nova Shard Upgrade Button
            function updateNovaShardUpgradeButton(upgradeName, btnId, costId, levelId) {
                const upgrade = gameState.upgrades[upgradeName];
                const cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.costMultiplier, upgrade.level));
                document.getElementById(btnId).disabled = gameState.novaShards < cost;
                document.getElementById(costId).textContent = cost.toLocaleString();
                document.getElementById(levelId).textContent = upgrade.level;
            }

            // Handle upgrades
            function purchaseUpgrade(upgradeName) {
                const upgrade = gameState.upgrades[upgradeName];
                const cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.costMultiplier, upgrade.level));
                
                if (gameState.starlight >= cost) {
                    gameState.starlight -= cost;
                    upgrade.level++;
                    
                    // Apply upgrade effects
                    if (upgradeName === 'craftSpeed') {
                        gameState.starsPerSecond = 0.1 + upgrade.level * 0.05;
                        gameState.craftTime = Math.max(1, 10 - upgrade.level * 0.1);
                    } else if (upgradeName === 'starlightValue') {
                        gameState.starlightPerStar = 1 + upgrade.level * 0.1;
                    } else if (upgradeName === 'starQuality') {
                        gameState.starQuality = 1 + upgrade.level;
                        const qualityNames = ['Dim', 'Bright', 'Radiant', 'Nova'];
                        gameState.starQualityName = qualityNames[Math.min(upgrade.level, qualityNames.length - 1)];
                    } else if (upgradeName === 'starLongevity') {
                        // No direct effect here; star life is calculated on creation
                    }
                }
            }

            // Handle constellation upgrades (Stars Crafted)
            function purchaseConstellationUpgrade(upgradeName) {
                const upgrade = gameState.upgrades[upgradeName];
                const cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.costMultiplier, upgrade.level));
                
                if (gameState.starsCreated >= cost) {
                    gameState.starsCreated -= cost;
                    upgrade.level++;
                }
            }

            // Handle automation
            function purchaseAutomation() {
                const upgrade = gameState.upgrades.automation;
                if (!upgrade.unlocked && gameState.starlight >= upgrade.baseCost) {
                    gameState.starlight -= upgrade.baseCost;
                    upgrade.unlocked = true;
                }
            }

            // Handle prestige
            function prestige() {
                if (gameState.starsCreated >= 1000 || gameState.totalStarlight >= 10000) {
                    const shards = Math.floor(Math.sqrt(gameState.totalStarlight / 100));
                    
                    // Reset game state
                    gameState.novaShards += shards;
                    gameState.starlight = 0;
                    gameState.totalStarlight = 0;
                    gameState.starsCreated = 0;
                    gameState.craftProgress = 0;
                    gameState.starsPerSecond = 0.1;
                    gameState.starlightPerStar = 1;
                    gameState.starQuality = 1;
                    gameState.starQualityName = "Dim";
                    gameState.stars = [];
                    
                    // Reset upgrades
                    for (const key in gameState.upgrades) {
                        gameState.upgrades[key].level = 0;
                        if (key === 'automation') {
                            gameState.upgrades[key].unlocked = false;
                        }
                    }
                    
                    saveGame();
                }
            }

            // Handle Nova Shard upgrades
            function purchaseNovaShardUpgrade(upgradeName) {
                const upgrade = gameState.upgrades[upgradeName];
                const cost = Math.floor(upgrade.baseCost * Math.pow(upgrade.costMultiplier, upgrade.level));
                if (gameState.novaShards >= cost) {
                    gameState.novaShards -= cost;
                    upgrade.level++;
                }
            }

            // Handle canvas click
            canvas.addEventListener('click', (e) => {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                // Check if click is near forge
                const dist = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
                if (dist < 60) {
                    // Speed up crafting
                    gameState.craftProgress += 0.1;
                    
                    // Visual feedback
                    ctx.save();
                    ctx.fillStyle = 'rgba(255, 255, 0, 0.5)';
                    ctx.beginPath();
                    ctx.arc(centerX, centerY, 60, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.restore();
                }
            });

            // Button event listeners
            function safeAddEventListener(id, event, handler) {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener(event, handler);
                } else {
                    console.warn('Element not found for event listener:', id);
                }
            }
            safeAddEventListener('craftSpeedBtn', 'click', () => purchaseUpgrade('craftSpeed'));
            safeAddEventListener('starlightValueBtn', 'click', () => purchaseUpgrade('starlightValue'));
            safeAddEventListener('starQualityBtn', 'click', () => purchaseUpgrade('starQuality'));
            safeAddEventListener('automationBtn', 'click', purchaseAutomation);
            safeAddEventListener('prestigeBtn', 'click', prestige);
            safeAddEventListener('starLongevityBtn', 'click', () => purchaseUpgrade('starLongevity'));
            safeAddEventListener('constellationPowerBtn', 'click', () => purchaseConstellationUpgrade('constellationPower'));
            safeAddEventListener('celestialEfficiencyBtn', 'click', () => purchaseConstellationUpgrade('celestialEfficiency'));
            safeAddEventListener('galacticMagnetismBtn', 'click', () => purchaseConstellationUpgrade('galacticMagnetism'));
            safeAddEventListener('astralStorageBtn', 'click', () => purchaseConstellationUpgrade('astralStorage'));
            safeAddEventListener('quantumForgeBtn', 'click', () => purchaseNovaShardUpgrade('quantumForge'));
            safeAddEventListener('eternalLightBtn', 'click', () => purchaseNovaShardUpgrade('eternalLight'));
            safeAddEventListener('celestialMemoryBtn', 'click', () => purchaseNovaShardUpgrade('celestialMemory'));
            safeAddEventListener('stellarMagnetBtn', 'click', () => purchaseNovaShardUpgrade('stellarMagnet'));
            safeAddEventListener('astralEchoBtn', 'click', () => purchaseNovaShardUpgrade('astralEcho'));

            // Save/Load functions
            function saveGame() {
                const saveData = {
                    version: 1,
                    gameState: gameState,
                    timestamp: Date.now()
                };
                localStorage.setItem('starforgeOdyssey', JSON.stringify(saveData));
                gameState.lastSave = Date.now();
            }

            function loadGame() {
                const saveString = localStorage.getItem('starforgeOdyssey');
                if (saveString) {
                    try {
                        const saveData = JSON.parse(saveString);
                        // Load game state
                        Object.assign(gameState, saveData.gameState);
                        // Ensure new properties exist after loading
                        if (typeof gameState.baseStarLife !== 'number') gameState.baseStarLife = 5;
                        if (typeof gameState.starLifePerLevel !== 'number') gameState.starLifePerLevel = 2;
                        if (!gameState.upgrades.starLongevity) gameState.upgrades.starLongevity = { level: 0, baseCost: 50, costMultiplier: 2 };
                        // Ensure constellation upgrades exist
                        if (!gameState.upgrades.constellationPower) gameState.upgrades.constellationPower = { level: 0, baseCost: 100, costMultiplier: 2 };
                        if (!gameState.upgrades.celestialEfficiency) gameState.upgrades.celestialEfficiency = { level: 0, baseCost: 200, costMultiplier: 2 };
                        if (!gameState.upgrades.galacticMagnetism) gameState.upgrades.galacticMagnetism = { level: 0, baseCost: 150, costMultiplier: 2 };
                        if (!gameState.upgrades.astralStorage) gameState.upgrades.astralStorage = { level: 0, baseCost: 10, costMultiplier: 1.1 };
                        // Always force new Astral Storage cost and scaling for old saves
                        gameState.upgrades.astralStorage.baseCost = 10;
                        gameState.upgrades.astralStorage.costMultiplier = 1.1;
                        // Ensure nova shard upgrades exist
                        if (!gameState.upgrades.quantumForge) gameState.upgrades.quantumForge = { level: 0, baseCost: 1, costMultiplier: 2 };
                        if (!gameState.upgrades.eternalLight) gameState.upgrades.eternalLight = { level: 0, baseCost: 1, costMultiplier: 2 };
                        if (!gameState.upgrades.celestialMemory) gameState.upgrades.celestialMemory = { level: 0, baseCost: 2, costMultiplier: 2 };
                        if (!gameState.upgrades.stellarMagnet) gameState.upgrades.stellarMagnet = { level: 0, baseCost: 3, costMultiplier: 2 };
                        if (!gameState.upgrades.astralEcho) gameState.upgrades.astralEcho = { level: 0, baseCost: 3, costMultiplier: 2 };
                        // Ensure all upgrades exist
                        if (!gameState.upgrades.craftSpeed) gameState.upgrades.craftSpeed = { level: 0, baseCost: 10, costMultiplier: 1.15 };
                        if (!gameState.upgrades.starlightValue) gameState.upgrades.starlightValue = { level: 0, baseCost: 15, costMultiplier: 1.2 };
                        if (!gameState.upgrades.starQuality) gameState.upgrades.starQuality = { level: 0, baseCost: 100, costMultiplier: 2 };
                        if (!gameState.upgrades.automation) gameState.upgrades.automation = { level: 0, baseCost: 500, unlocked: false };
                        // Clear visual elements
                        gameState.stars = [];
                        gameState.blackHoles = []; // Clear black holes on load
                        // Calculate offline progress
                        const offlineTime = Math.min((Date.now() - saveData.timestamp) / 1000, 86400); // Cap at 24 hours
                        if (gameState.upgrades.automation.unlocked && offlineTime > 0) {
                            const offlineStars = Math.floor(offlineTime * gameState.starsPerSecond);
                            const offlineStarlight = offlineStars * gameState.starlightPerStar * gameState.starQuality * (1 + gameState.novaShards * 0.1);
                            gameState.starsCreated += offlineStars;
                            gameState.starlight += offlineStarlight;
                            gameState.totalStarlight += offlineStarlight;
                            console.log(`Welcome back! You earned ${Math.floor(offlineStarlight)} starlight while away.`);
                        }
                        // Update timestamps
                        gameState.lastUpdate = Date.now();
                        gameState.lastSave = Date.now();
                    } catch (e) {
                        console.error('Failed to load save:', e);
                    }
                } else {
                    // Ensure new properties exist on fresh start
                    if (typeof gameState.baseStarLife !== 'number') gameState.baseStarLife = 5;
                    if (typeof gameState.starLifePerLevel !== 'number') gameState.starLifePerLevel = 2;
                    if (!gameState.upgrades.starLongevity) gameState.upgrades.starLongevity = { level: 0, baseCost: 50, costMultiplier: 2 };
                    if (!gameState.upgrades.constellationPower) gameState.upgrades.constellationPower = { level: 0, baseCost: 100, costMultiplier: 2 };
                    if (!gameState.upgrades.celestialEfficiency) gameState.upgrades.celestialEfficiency = { level: 0, baseCost: 200, costMultiplier: 2 };
                    if (!gameState.upgrades.galacticMagnetism) gameState.upgrades.galacticMagnetism = { level: 0, baseCost: 150, costMultiplier: 2 };
                    if (!gameState.upgrades.astralStorage) gameState.upgrades.astralStorage = { level: 0, baseCost: 10, costMultiplier: 1.1 };
                    if (!gameState.upgrades.quantumForge) gameState.upgrades.quantumForge = { level: 0, baseCost: 1, costMultiplier: 2 };
                    if (!gameState.upgrades.eternalLight) gameState.upgrades.eternalLight = { level: 0, baseCost: 1, costMultiplier: 2 };
                    if (!gameState.upgrades.celestialMemory) gameState.upgrades.celestialMemory = { level: 0, baseCost: 2, costMultiplier: 2 };
                    if (!gameState.upgrades.stellarMagnet) gameState.upgrades.stellarMagnet = { level: 0, baseCost: 3, costMultiplier: 2 };
                    if (!gameState.upgrades.astralEcho) gameState.upgrades.astralEcho = { level: 0, baseCost: 3, costMultiplier: 2 };
                }
            }

            // Initialize game
            loadGame();
            gameLoop();

            // Save/Load/Reset button handlers
            document.getElementById('saveGameBtn').addEventListener('click', function() {
                saveGame();
                showSaveLoadNotif('Game saved!');
            });
            document.getElementById('loadGameBtn').addEventListener('click', function() {
                loadGame();
                showSaveLoadNotif('Game loaded!');
            });
            document.getElementById('resetGameBtn').addEventListener('click', resetGameConfirm);

            function showSaveLoadNotif(msg) {
                const notif = document.getElementById('saveLoadNotif');
                notif.textContent = msg;
                notif.style.display = 'block';
                setTimeout(() => { notif.style.display = 'none'; }, 1500);
            }

            function resetGameConfirm() {
                if (confirm('Are you sure you want to reset your game? This cannot be undone.')) {
                    localStorage.removeItem('starforgeOdyssey');
                    location.reload();
                }
            }
        });
    </script>
</body>
</html>
